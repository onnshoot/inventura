<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Inventūra</title>
  <!-- PWA basics -->
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Inventory Counter&quot;,&quot;short_name&quot;:&quot;Inventūra&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#111&quot;,&quot;theme_color&quot;:&quot;#111&quot;}">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root{
      --bg:#0f1115; --card:#151822; --line:#25293a; --muted:#9aa3b2; --ink:#e8e8e8;
      --btn-bg:#1a1f2e; --btn-bd:#2b2f43; --ok:#8cffb7; --warn:#ffd27d; --err:#ff9aa2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    header{padding:12px 16px;font-weight:700;background:var(--card);position:sticky;top:0;z-index:10;border-bottom:1px solid var(--line)}
    main{padding:12px 16px 120px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button,input{padding:10px 12px;border-radius:10px;border:1px solid var(--btn-bd);background:var(--btn-bg);color:var(--ink)}
    input{min-width:220px}
    button:active{transform:scale(.98)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
    .muted{color:var(--muted)}
    .pill{font-variant-numeric:tabular-nums;padding:4px 8px;border-radius:9999px;background:#1f2435;border:1px solid var(--btn-bd)}
    .grid{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center}
    .footer{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--line);padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .pulse{animation:pulse 300ms ease-in-out}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(.97)}100%{transform:scale(1)}}
  </style>
</head>
<body>
<header>Inventūra</header>
<main>
  <div class="card">
    <div class="row">
      <span id="status" class="muted">Idle</span>
      <button id="btnUpdate" title="Refresh cached files">Update</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <b>Counts</b>
      <button id="btnExport" title="Export CSV (code,count)">Export CSV</button>
      <button id="btnClear" title="Delete all">Clear All</button>
    </div>
    <div class="row" style="margin-top:8px;gap:6px">
      <input id="manualCode" placeholder="Manual add: 8 digits" inputmode="numeric" maxlength="8" autocomplete="off" />
      <button id="btnAddManual">Add</button>
    </div>
    <div id="countsWrap" style="margin-top:4px"></div>
  </div>
</main>

<div class="footer">
  <span>Scanned: <span id="scanTotal" class="pill">0</span></span>
  <span>Unique: <span id="uniqueTotal" class="pill">0</span></span>
  <span>Last: <span id="lastCode" class="pill muted">—</span></span>
</div>

<!-- libs (LOCAL copy for full offline) -->
<script src="./vendor/localforage/localforage.min.js"></script>
<script>
  // -------- Storage (IndexedDB via localForage) --------
  const store = localforage.createInstance({ name:'inventory', storeName:'codes' });
  const getAll = async()=> (await store.getItem('data')) || {};
  const setAll = async(d)=> store.setItem('data', d);
  const inc = async(code)=>{ const d=await getAll(); d[code]=(d[code]||0)+1; await setAll(d); return d[code]; };
  const setCount = async(code,val)=>{ const d=await getAll(); if(val<=0) delete d[code]; else d[code]=val; await setAll(d); };
  const clearAll = async()=> setAll({});

  // -------- UI refs --------
  const els = {
    status: document.getElementById('status'),
    countsWrap: document.getElementById('countsWrap'),
    scanTotal: document.getElementById('scanTotal'),
    uniqueTotal: document.getElementById('uniqueTotal'),
    lastCode: document.getElementById('lastCode'),
    btnExport: document.getElementById('btnExport'),
    btnClear: document.getElementById('btnClear'),
    manualCode: document.getElementById('manualCode'),
    btnAddManual: document.getElementById('btnAddManual'),
    btnUpdate: document.getElementById('btnUpdate')
  };

  // -------- Helpers --------
  const setStatus = (msg, cls='muted')=>{ els.status.className=cls; els.status.textContent=msg; };
  const flashButton = (el)=>{ if(!el) return; el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); };
  const beep = (ok=true)=>{ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type= ok?'triangle':'sawtooth'; o.frequency.value= ok?880:220; o.connect(g); g.connect(ctx.destination); g.gain.value=0.02; o.start(); setTimeout(()=>{o.stop(); ctx.close()}, 120);}catch(e){} };
  const onlyDigits = (s)=> s.replace(/\D+/g,'');

  const totalCount = (obj)=> Object.values(obj).reduce((a,b)=>a+Number(b||0),0);

  // -------- Render table --------
  async function refresh() {
    const data = await getAll();
    const entries = Object.entries(data).sort((a,b)=>a[0].localeCompare(b[0]));
    els.uniqueTotal.textContent = entries.length;
    els.scanTotal.textContent = totalCount(data);

    els.countsWrap.innerHTML = entries.length
      ? `<table><thead><tr><th>Code</th><th>Count</th><th></th></tr></thead><tbody>
           ${entries.map(([code,cnt])=>`
             <tr>
               <td><code>${code}</code></td>
               <td class="grid">
                 <span>${cnt}</span>
                 <button data-dec="${code}" title="-1">−</button>
                 <button data-inc="${code}" title="+1">+</button>
               </td>
               <td><button data-del="${code}" title="Delete">Delete</button></td>
             </tr>`).join('')}
         </tbody></table>`
      : `<div class="muted">No entries yet.</div>`;
  }

  els.countsWrap.addEventListener('click', async (e)=>{
    const t = e.target; if(!(t instanceof HTMLElement)) return;
    if (t.dataset.inc){ const c=t.dataset.inc; await setCount(c, ((await getAll())[c]||0)+1); refresh(); }
    if (t.dataset.dec){ const c=t.dataset.dec; await setCount(c, ((await getAll())[c]||0)-1); refresh(); }
    if (t.dataset.del){ const c=t.dataset.del; await setCount(c, 0); refresh(); }
  });

  // -------- Events --------
  els.manualCode.addEventListener('input',()=>{ els.manualCode.value = onlyDigits(els.manualCode.value).slice(0,8); });
  els.manualCode.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ els.btnAddManual.click(); } });

  els.btnAddManual.onclick = async () => {
    flashButton(els.btnAddManual);
    const v = (els.manualCode.value||'').trim();
    if (!/^\d{8}$/.test(v)) { setStatus('Enter exactly 8 digits', 'warn'); beep(false); return; }
    await inc(v);
    els.manualCode.value='';
    els.lastCode.textContent=v; els.lastCode.classList.remove('muted');
    setStatus('Added '+v, 'ok'); beep(true);
    refresh();
  };

  els.btnExport.onclick = async () => {
    flashButton(els.btnExport);
    const data = await getAll();
    const rows = Object.entries(data).map(([k,v])=>`${k},${v}`).join('\n');
    const blob = new Blob([rows], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='inventory_counts.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    setStatus('CSV exported', 'ok');
  };

  els.btnClear.onclick = async () => {
    flashButton(els.btnClear);
    if (!confirm('Delete all counts?')) return;
    await clearAll();
    els.lastCode.textContent='—'; els.lastCode.classList.add('muted');
    setStatus('All data cleared', 'ok');
    refresh();
  };

  els.btnUpdate.onclick = async () => {
    flashButton(els.btnUpdate);
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) await r.unregister();
      }
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    } catch(e) { console.warn(e); }
    location.reload();
  };

  // -------- Service Worker (cache-first) --------
  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE='inv-v1';
      const FILES=['./','./index.html','./vendor/localforage/localforage.min.js'];
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(FILES))); self.skipWaiting(); });
      self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim(); });
      self.addEventListener('fetch',e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });
    `;
    const swUrl = URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
    navigator.serviceWorker.register(swUrl);
  }

  // -------- Init --------
  refresh();
  setStatus('Ready');
</script>
</body>
</html>
