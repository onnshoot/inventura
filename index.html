<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventūra</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="data:application/manifest+json,{\"name\":\"EZU Inventura\",\"short_name\":\"Inventura\",\"display\":\"standalone\",\"start_url\":\".\"}" />
  <style>
    :root { --bg:#0f1115; --card:#171a21; --muted:#a3adba; --text:#e7ecf3; --accent:#4f8cff; --danger:#ff6b6b; }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:20px;}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    h1{font-size:20px;margin:0 8px 0 0}
    .card{background:var(--card);border:1px solid #222733;border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"], input[type="number"]{background:#0c0e13;border:1px solid #2a3140;color:var(--text);border-radius:10px;padding:12px 14px;outline:none}
    input[type="text"]{flex:1;min-width:180px;font-size:18px;letter-spacing:1px}
    button{background:#1f2430;border:1px solid #2a3140;color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer}
    button:hover{border-color:#3a4256}
    .btn-accent{background:var(--accent);border-color:var(--accent);color:white}
    .btn-danger{background:transparent;border-color:var(--danger);color:var(--danger)}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
    thead th{font-weight:600;color:var(--muted);text-align:left;padding:6px 10px}
    tbody tr{background:#0c0e13}
    tbody td{padding:8px 10px;border-top:1px solid #202634;border-bottom:1px solid #202634}
    tbody tr:first-child td{border-top-left-radius:10px;border-top-right-radius:10px}
    tbody tr:last-child td{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;letter-spacing:1px}
    .qty{display:flex;align-items:center;gap:6px}
    .qty button{min-width:36px}

    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:10px}
    .total{font-weight:600}

    .pill{padding:6px 10px;border-radius:999px;background:#12151c;border:1px solid #232a39;color:var(--muted)}
    .wide{width:100%}

    /* iOS Safari download fallback */
    #fallbackBox{display:none;margin-top:10px}
    textarea{width:100%;min-height:120px;background:#0c0e13;color:var(--text);border:1px solid #2a3140;border-radius:10px;padding:10px}

    @media (hover:none){ button:active{transform:scale(0.98)} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>EZU Inventūra</h1>
      <span class="pill" id="status">Saglabā lokāli</span>
    </header>

    <section class="card">
      <div class="row">
        <label for="code" class="muted">8‑ciparu kods</label>
        <input id="code" type="text" inputmode="numeric" pattern="\\d{8}" placeholder="00000000" autocomplete="one-time-code" aria-label="8 ciparu kods" />
        <button id="addBtn" class="btn-accent">Pievienot / +1 (Enter)</button>
        <button id="minusBtn">-1</button>
      </div>
      <div class="toolbar">
        <button id="clearBtn" class="btn-danger">Notīrīt visu</button>
        <button id="exportCsvBtn">Eksportēt CSV</button>
        <button id="exportJsonBtn">Eksportēt JSON</button>
        <button id="copyCsvBtn">Kopēt CSV starpliktuvē</button>
        <span class="muted">Dati tiek glabāti šajā pārlūkā (localStorage).</span>
      </div>

      <div id="fallbackBox" class="card">
        <div class="muted" style="margin-bottom:6px">iOS Safari lejupielāde var nedarboties. Nokopē datus no laukā zemāk:</div>
        <textarea id="fallbackText" readonly></textarea>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Kods</th>
            <th>Skaits</th>
            <th>Darbības</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="footer">
        <div class="total">Kopā vienību: <span id="total">0</span></div>
        <div class="muted">Pēdējā saglabāšana: <span id="savedAt">—</span></div>
      </div>
    </section>
  </div>

<script>
(function(){
  'use strict';
  var KEY = 'ezu-inventura-v1';
  var state = load() || { items: {} }; // { code: count }
  var codeEl = document.getElementById('code');
  var addBtn = document.getElementById('addBtn');
  var minusBtn = document.getElementById('minusBtn');
  var tbody = document.getElementById('tbody');
  var totalEl = document.getElementById('total');
  var savedAtEl = document.getElementById('savedAt');
  var statusEl = document.getElementById('status');
  var exportCsvBtn = document.getElementById('exportCsvBtn');
  var exportJsonBtn = document.getElementById('exportJsonBtn');
  var copyCsvBtn = document.getElementById('copyCsvBtn');
  var clearBtn = document.getElementById('clearBtn');
  var fallbackBox = document.getElementById('fallbackBox');
  var fallbackText = document.getElementById('fallbackText');

  // Helpers
  function pad(n){ return (''+n).padStart(8,'0'); }
  function nowStr(){ var d=new Date(); return d.toLocaleString(); }
  function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

  function save(){
    try {
      localStorage.setItem(KEY, JSON.stringify({items: state.items, savedAt: Date.now()}));
      statusEl.textContent = 'Saglabāts';
      savedAtEl.textContent = nowStr();
      setTimeout(function(){ statusEl.textContent = 'Saglabā lokāli'; }, 1200);
    } catch(e){ console.error(e); statusEl.textContent = 'Saglabāšana neizdevās'; }
  }
  function load(){
    try{ var raw = localStorage.getItem(KEY); return raw? JSON.parse(raw) : null; }catch(_){ return null; }
  }

  function render(){
    // clear tbody
    while(tbody.firstChild) tbody.removeChild(tbody.firstChild);
    var total = 0;
    var codes = Object.keys(state.items).sort();
    codes.forEach(function(code){
      var count = state.items[code];
      total += count;
      var tr = document.createElement('tr');

      var tdCode = document.createElement('td');
      tdCode.textContent = code; tdCode.className = 'code';

      var tdQty = document.createElement('td');
      var qtyWrap = document.createElement('div'); qtyWrap.className='qty';
      var minus = document.createElement('button'); minus.textContent='−'; minus.title='Samazināt';
      var qty = document.createElement('input'); qty.type='number'; qty.value=count; qty.min='0'; qty.style.width='80px'; qty.setAttribute('aria-label','Skaits');
      var plus = document.createElement('button'); plus.textContent='+'; plus.className='btn-accent'; plus.title='Palielināt';

      minus.addEventListener('click', function(){ adjust(code, -1); });
      plus.addEventListener('click', function(){ adjust(code, +1); });
      qty.addEventListener('change', function(){ setCount(code, parseInt(qty.value||'0',10)); });

      qtyWrap.appendChild(minus); qtyWrap.appendChild(qty); qtyWrap.appendChild(plus);
      tdQty.appendChild(qtyWrap);

      var tdActions = document.createElement('td');
      var del = document.createElement('button'); del.textContent='Dzēst'; del.className='btn-danger';
      del.addEventListener('click', function(){ remove(code); });
      tdActions.appendChild(del);

      tr.appendChild(tdCode); tr.appendChild(tdQty); tr.appendChild(tdActions);
      tbody.appendChild(tr);
    });
    totalEl.textContent = total;
    var loaded = load();
    if(loaded && loaded.savedAt){ savedAtEl.textContent = new Date(loaded.savedAt).toLocaleString(); }
  }

  function normalizeCode(input){
    var digits = (input||'').replace(/\D/g,'');
    if(digits.length === 8) return digits;
    return null;
  }

  function add(code){
    if(!state.items[code]) state.items[code]=0;
    state.items[code] += 1;
    save(); render();
  }

  function adjust(code, delta){
    if(!state.items[code]) return; // nothing to do
    state.items[code] = Math.max(0, (state.items[code]||0) + delta);
    if(state.items[code] === 0) delete state.items[code];
    save(); render();
  }

  function setCount(code, val){
    if(!(val>=0)) return;
    if(val===0){ delete state.items[code]; } else { state.items[code]=val; }
    save(); render();
  }

  function remove(code){
    delete state.items[code]; save(); render();
  }

  function asCsv(){
    var lines = ['code,count'];
    Object.keys(state.items).sort().forEach(function(c){ lines.push(c+','+state.items[c]); });
    return lines.join('\n');
  }
  function asJson(){
    return JSON.stringify({ items: state.items, exportedAt: new Date().toISOString() }, null, 2);
  }

  function download(filename, mime, text){
    try{
      var blob = new Blob([text], {type: mime});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = filename;
      // iOS Safari often ignores download attribute; open a new tab as fallback
      if(isIOS()){
        // try open
        var opened = window.open('data:' + mime + ';charset=utf-8,' + encodeURIComponent(text), '_blank');
        if(!opened){ fallbackBox.style.display='block'; fallbackText.value=text; }
      } else {
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }
      setTimeout(function(){ URL.revokeObjectURL(url); }, 2000);
    }catch(e){ console.error(e); fallbackBox.style.display='block'; fallbackText.value=text; }
  }

  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(text).then(function(){ statusEl.textContent='Nokopēts'; setTimeout(function(){ statusEl.textContent='Saglabā lokāli'; },1200); });
    } else {
      // fallback
      fallbackBox.style.display='block'; fallbackText.value=text; fallbackText.focus(); fallbackText.select();
      try{ document.execCommand('copy'); }catch(_){}
    }
  }

  // Events
  addBtn.addEventListener('click', function(){
    var code = normalizeCode(codeEl.value);
    if(!code){ codeEl.focus(); codeEl.select(); return; }
    add(code); codeEl.value=''; codeEl.focus();
  });
  minusBtn.addEventListener('click', function(){
    var code = normalizeCode(codeEl.value);
    if(!code){ codeEl.focus(); codeEl.select(); return; }
    adjust(code, -1); codeEl.value=''; codeEl.focus();
  });
  codeEl.addEventListener('keydown', function(e){
    if(e.key==='Enter') { addBtn.click(); }
  });

  exportCsvBtn.addEventListener('click', function(){
    var csv = asCsv();
    var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
    download('inventory-'+stamp+'.csv', 'text/csv', csv);
  });
  exportJsonBtn.addEventListener('click', function(){
    var json = asJson();
    var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
    download('inventory-'+stamp+'.json', 'application/json', json);
  });
  copyCsvBtn.addEventListener('click', function(){ copyToClipboard(asCsv()); });

  clearBtn.addEventListener('click', function(){
    if(confirm('Vai tiešām dzēst visu?')){ state.items = {}; save(); render(); }
  });

  // Init
  render();
  codeEl.focus();
})();
</script>
</body>
</html>
