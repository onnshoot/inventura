<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventūra</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="data:application/manifest+json,{\"name\":\"EZU Inventura\",\"short_name\":\"Inventura\",\"display\":\"standalone\",\"start_url\":\".\"}" />
  <style>
    :root { --bg:#0f1115; --card:#171a21; --muted:#a3adba; --text:#e7ecf3; --accent:#4f8cff; --danger:#ff6b6b; }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:20px;}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    h1{font-size:20px;margin:0 8px 0 0}
    .card{background:var(--card);border:1px solid #222733;border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"], input[type="number"]{background:#0c0e13;border:1px solid #2a3140;color:var(--text);border-radius:10px;padding:12px 14px;outline:none}
    input[type="text"]{flex:1;min-width:180px;font-size:18px;letter-spacing:1px}
    button{background:#1f2430;border:1px solid #2a3140;color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer}
    button:hover{border-color:#3a4256}
    .btn-accent{background:var(--accent);border-color:var(--accent);color:white}
    .btn-danger{background:transparent;border-color:var(--danger);color:var(--danger)}
    .muted{color:var(--muted)}
    .toolbar{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #multiplier{width:80px}

    table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px;table-layout:fixed}
    thead th{font-weight:600;color:var(--muted);text-align:left;padding:6px 10px}
    tbody tr{background:#0c0e13}
    tbody td{padding:8px 10px;border-top:1px solid #202634;border-bottom:1px solid #202634}
    tbody tr:first-child td{border-top-left-radius:10px;border-top-right-radius:10px}
    tbody tr:last-child td{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;letter-spacing:1px}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:10px}
    .total{font-weight:600}

    .pill{padding:6px 10px;border-radius:999px;background:#12151c;border:1px solid #232a39;color:var(--muted)}
    .wide{width:100%}

    /* iOS Safari download fallback */
    #fallbackBox{display:none;margin-top:10px}
    textarea{width:100%;min-height:120px;background:#0c0e13;color:var(--text);border:1px solid #2a3140;border-radius:10px;padding:10px}

    @media (hover:none){ button:active{transform:scale(0.98)} }

    html,body{overscroll-behavior:contain;}
    @media (max-width: 480px){
      .wrap{padding:12px}
      header{margin-bottom:10px}
      input[type="text"]{min-width:0; flex:1}
      .row{gap:8px}
      button{padding:12px 14px}
      table{font-size:14px}
      thead th, tbody td{padding:8px}
    }
    thead th:nth-child(1), tbody td:nth-child(1){width:50%;word-break:break-all}
    thead th:nth-child(2), tbody td:nth-child(2){width:50%;}
    .qty{display:flex;align-items:center;gap:4px}
    .qty button{min-width:30px;padding:8px 10px}
    .qty input{width:64px;padding:8px 10px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>EŽU Inventūra</h1>
      <span class="pill" id="status">Saglabā lokāli</span>
    </header>

    <section class="card">
      <form id="addForm" class="row" novalidate>
        <label for="code" class="muted">8‑ciparu kods</label>
        <input id="code" type="text" inputmode="numeric" pattern="\\d{8}" placeholder="00000000" autocomplete="one-time-code" aria-label="8 ciparu kods" />
      </form>
      <div class="toolbar">
        <div class="toolbar-row">
          <button id="clearBtn" class="btn-danger">Notīrīt visu</button>
          <button id="shareCsvBtn" class="btn-accent">Kopīgot CSV (tālrunī)</button>
          <input id="multiplier" type="number" min="1" value="1" inputmode="numeric" aria-label="Reizināt skaitu" title="Reizināt ievadītā koda skaitu" />
        </div>
        <span id="lastCodeDisplay" class="muted">Pēdējais ievadītais kods: —</span>
      </div>

      <div id="fallbackBox" class="card">
        <div class="muted" style="margin-bottom:6px">iOS Safari lejupielāde var nedarboties. Nokopē datus no laukā zemāk:</div>
        <div id="fallbackFilename" class="muted" style="margin-bottom:6px;display:none"></div>
        <textarea id="fallbackText" readonly></textarea>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Kods</th>
            <th>Skaits</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="footer">
        <div class="total">Kopā vienību: <span id="total">0</span></div>
        <div class="muted">Pēdējā saglabāšana: <span id="savedAt">—</span></div>
      </div>
    </section>
  </div>

<script>
(function(){
  'use strict';
  var KEY = 'ezu-inventura-v1';
  var state = load() || { items: {}, lastEntry: null };
  if(!state.items) state.items = {};
  if(typeof state.lastEntry === 'undefined') state.lastEntry = null;
  if(typeof state.savedAt === 'undefined') state.savedAt = null;
  var codeEl = document.getElementById('code');
  var tbody = document.getElementById('tbody');
  var totalEl = document.getElementById('total');
  var savedAtEl = document.getElementById('savedAt');
  var statusEl = document.getElementById('status');
  var shareCsvBtn = document.getElementById('shareCsvBtn');
  var clearBtn = document.getElementById('clearBtn');
  var multiplierEl = document.getElementById('multiplier');
  var lastCodeEl = document.getElementById('lastCodeDisplay');
  var fallbackBox = document.getElementById('fallbackBox');
  var fallbackFilename = document.getElementById('fallbackFilename');
  var fallbackText = document.getElementById('fallbackText');
  var addForm = document.getElementById('addForm');

  // Helpers
  function nowStr(){ var d=new Date(); return d.toLocaleString(); }
  function stamp(){
    var d = new Date();
    var yyyy = d.getFullYear();
    var mm = String(d.getMonth()+1).padStart(2,'0');
    var dd = String(d.getDate()).padStart(2,'0');
    var hh = String(d.getHours()).padStart(2,'0');
    var min = String(d.getMinutes()).padStart(2,'0');
    return yyyy+mm+dd+'-'+hh+min;
  }

  function save(){
    try {
      var ts = Date.now();
      state.savedAt = ts;
      localStorage.setItem(KEY, JSON.stringify({items: state.items, savedAt: ts, lastEntry: state.lastEntry}));
      statusEl.textContent = 'Saglabāts';
      savedAtEl.textContent = nowStr();
      setTimeout(function(){ statusEl.textContent = 'Saglabā lokāli'; }, 1200);
    } catch(e){ console.error(e); statusEl.textContent = 'Saglabāšana neizdevās'; }
  }
  function load(){
    try{ var raw = localStorage.getItem(KEY); return raw? JSON.parse(raw) : null; }catch(_){ return null; }
  }

  function render(){
    // clear tbody
    while(tbody.firstChild) tbody.removeChild(tbody.firstChild);
    var total = 0;
    var codes = Object.keys(state.items).sort();
    codes.forEach(function(code){
      var count = state.items[code];
      total += count;
      var tr = document.createElement('tr');

      var tdCode = document.createElement('td');
      tdCode.textContent = code; tdCode.className = 'code';

      var tdQty = document.createElement('td');
      var qtyWrap = document.createElement('div'); qtyWrap.className='qty';
      var minus = document.createElement('button'); minus.textContent='−'; minus.title='Samazināt';
      var qty = document.createElement('input'); qty.type='number'; qty.value=count; qty.min='0'; qty.setAttribute('aria-label','Skaits');

      minus.addEventListener('click', function(){
        var currentCount = state.items[code] || 0;
        if(currentCount <= 0) return;
        var message = 'Vai tiešām samazināt "' + code + '" skaitu par 1?';
        if(confirm(message)){ adjust(code, -1); }
      });
      qty.addEventListener('change', function(){ setCount(code, parseInt(qty.value||'0',10)); });

      qtyWrap.appendChild(minus); qtyWrap.appendChild(qty);
      tdQty.appendChild(qtyWrap);

      tr.appendChild(tdCode); tr.appendChild(tdQty);
      tbody.appendChild(tr);
    });
    totalEl.textContent = total;
    updateLastCodeDisplay();
    if(state.savedAt){ savedAtEl.textContent = new Date(state.savedAt).toLocaleString(); }
  }

  function normalizeCode(input){
    var digits = (input||'').replace(/\D/g,'');
    if(digits.length === 8) return digits;
    return null;
  }

  function getMultiplier(){
    if(!multiplierEl) return 1;
    var raw = parseInt(multiplierEl.value, 10);
    var multiplier = raw > 0 ? raw : 1;
    if(raw !== multiplier){ multiplierEl.value = String(multiplier); }
    return multiplier;
  }

  function updateLastCodeDisplay(){
    if(!lastCodeEl) return;
    if(state.lastEntry && state.lastEntry.code){
      var text = state.lastEntry.code;
      var amount = state.lastEntry.amount || 0;
      if(amount > 1){ text += ' ×' + amount; }
      lastCodeEl.textContent = 'Pēdējais ievadītais kods: ' + text;
    } else {
      lastCodeEl.textContent = 'Pēdējais ievadītais kods: —';
    }
  }

  function add(code, amount){
    var inc = (typeof amount === 'number' && amount > 0) ? Math.floor(amount) : 1;
    if(!state.items[code]) state.items[code]=0;
    state.items[code] += inc;
    state.lastEntry = { code: code, amount: inc };
    save(); render();
  }

  function adjust(code, delta){
    if(!state.items[code]) return; // nothing to do
    state.items[code] = Math.max(0, (state.items[code]||0) + delta);
    if(state.items[code] === 0) delete state.items[code];
    save(); render();
  }

  function setCount(code, val){
    if(!(val>=0)) return;
    if(val===0){ delete state.items[code]; } else { state.items[code]=val; }
    save(); render();
  }

  function asCsv(){
    var lines = ['code,count'];
    Object.keys(state.items).sort().forEach(function(c){ lines.push(c+','+state.items[c]); });
    return lines.join('\n');
  }
  function showFallback(csv, filename){
    fallbackBox.style.display='block';
    fallbackText.value=csv;
    if(fallbackFilename){
      fallbackFilename.textContent = 'Faila nosaukums: ' + filename;
      fallbackFilename.style.display='block';
    }
    fallbackBox.scrollIntoView({behavior:'smooth'});
  }

  async function shareCsv(){
    var csv = asCsv();
    var filename = 'inventory-' + stamp() + '.csv';
    try{
      var blob = new Blob([csv], {type:'text/csv'});
      var file = new File([blob], filename, {type:'text/csv'});
      if(navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
        await navigator.share({ files:[file], title:'Inventārs', text:'Inventāra CSV fails' });
        statusEl.textContent='Nosūtīts';
        setTimeout(function(){ statusEl.textContent='Saglabā lokāli'; }, 1200);
        return;
      }
      // Fallback: open in new tab as data URL so user can use Share
      var url = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      var w = window.open(url, '_blank');
      if(!w){ showFallback(csv, filename); }
    }catch(e){
      console.error(e);
      showFallback(csv, filename);
    }
  }

  // Events
  addForm.addEventListener('submit', function(e){
    e.preventDefault();
    var code = normalizeCode(codeEl.value);
    if(!code){ codeEl.focus(); codeEl.select(); return; }
    var amount = getMultiplier();
    add(code, amount);
    codeEl.value='';
    codeEl.focus();
  });

  codeEl.addEventListener('input', function(){
    var digits = (codeEl.value || '').replace(/\D/g,'');
    if(digits.length === 8){
      var code = normalizeCode(codeEl.value);
      if(code){
        var amount = getMultiplier();
        add(code, amount);
        codeEl.value = '';
        codeEl.focus();
      }
    }
  });
  codeEl.addEventListener('blur', function(){
    codeEl.value = '';
  });

  if(multiplierEl){
    multiplierEl.addEventListener('change', function(){
      getMultiplier();
    });
  }

  shareCsvBtn.addEventListener('click', function(){
    shareCsv();
  });

  clearBtn.addEventListener('click', function(){
    if(confirm('Vai tiešām dzēst visu?')){
      state.items = {};
      state.lastEntry = null;
      save();
      render();
    }
  });

  // Init
  render();
  codeEl.focus();
})();
</script>
</body>
</html>
